<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<project default="create_tmm_jar" name="Tiny Media Manager">

    <!-- software revision number -->
    <property name="version" value="Beta" />
    <tstamp>
        <format property="today" pattern="dd/MM/yyyy" />
    </tstamp>

    <path id="classpath.default">
        <fileset dir="lib">
            <include name="*.jar"/>
        </fileset>
    </path>

    <path id="svntask.classpth">
        <fileset dir="buildsupport/svntask">
            <include name="*.jar"/>
         </fileset>
    </path>
    <taskdef name="svn" classname="com.googlecode.svntask.SvnTask" classpathref="svntask.classpth"/>

    <target name="clean">
        <delete dir="bin" />
        <delete dir="build" />
        <delete dir="dist" />
    </target>

    <target name="init" depends="clean">
        <mkdir dir="bin" />
        <mkdir dir="build" />
        <mkdir dir="dist" />
    </target>

    <target name="compile" depends="init">
        <echo message="${ant.project.name}: ${ant.file}" />
        <javac debug="true" debuglevel="source,lines,vars" destdir="bin" source="1.6" target="1.6">
            <src path="src" />
            <classpath refid="classpath.default" />
        </javac>
    	<!-- copy non java files -->
        <copy includeemptydirs="false" todir="bin">
            <fileset dir="src" excludes="**/*.java" />
        </copy>
    </target>

    <target name="javadoc">
        <mkdir dir="reports/javadoc" />
        <javadoc access="public" destdir="reports/javadoc" author="true"
         version="true" use="true" windowtitle="${ant.project.name}">
            <classpath refid="classpath.default" />
            <fileset dir="src" defaultexcludes="yes">
                <include name="**/*.java" />
            </fileset>
        </javadoc>
    </target>

    <target name="create_resource_jar">
        <jar destfile="lib/resources.jar" basedir="resources" includes="*/**" />
    </target>

    <target name="create_tmm_jar" depends="compile">

        <svn>
            <info path="." />
            <!-- svn.info.url
                 svn.info.repositoryRootUrl
                 svn.info.revision
                 svn.info.author
                 svn.info.committedDate
                 svn.info.committedRevision -->
        </svn>
        <echo message="Building revision ${svn.info.revision} - ${svn.info.author} - ${svn.info.committedDate}" />

        <!-- set manifest Class-Path accordingly; fake jarFile parameter only used for relative path -->
        <manifestclasspath property="jar.classpath" jarfile="tmm.jar">
            <classpath refid="classpath.default" />
        </manifestclasspath>

        <jar destfile="build/tmm.jar">
            <manifest>
                <attribute name="Main-Class" value="org.tinymediamanager.TinyMediaManager" />
                <attribute name="Implementation-Version" value="${version} (r${svn.info.revision})" />
                <attribute name="SplashScreen-Image" value="org/tinymediamanager/ui/images/splashscreen.png" />
                <attribute name="Class-Path" value=". ${jar.classpath}" />
            </manifest>
            <fileset dir="bin" />
        </jar>

        <copy todir="build/lib">
            <fileset dir="lib"/>
        </copy>

        <!-- buildinfo -->
        <propertyfile file="build/version" comment="This file is automatically generated - DO NOT EDIT">
            <entry key="version" value="${version}" />
            <entry key="build" value="r${svn.info.revision}" />
            <entry key="date" value="${today}" />
        </propertyfile>
    </target>

    <target name='package-app' depends='create_tmm_jar'>

        <!-- getdown -->
        <mkdir dir="dist/getdown" />
        <mkdir dir="dist/getdown/lib" />
        <copy todir="dist/getdown/lib">
            <fileset dir="build/lib" includes="*" />
        </copy>
        <copy file="build/tmm.jar" todir="dist/getdown" />
        <copy file="build/version" todir="dist/getdown" />
        <copy file="objectdb.conf" todir="dist/getdown" />
        <copy file="AppBundler/getdown.txt" todir="dist/getdown" />
        <copy file="AppBundler/tmm.png" todir="dist/getdown" />
        <copy file="AppBundler/splashscreen.png" todir="dist/getdown" />
        <taskdef name="digest" classname="com.threerings.getdown.tools.DigesterTask" classpath="AppBundler/getdown-tools-1.2.jar" />
        <digest appdir="dist/getdown" />

        <!-- Mac OSX -->
        <mkdir dir="dist/mac" />
        <taskdef name="jarbundler" classname="net.sourceforge.jarbundler.JarBundler" classpath="AppBundler/jarbundler-2.2.0.jar" />
        <jarbundler dir="dist/mac" name="tinyMediaManager" icon="AppBundler/tmm.icns" mainclass="com.threerings.getdown.launcher.Getdown" arguments="." bundleid="org.tinyMediaManager.tinymediamanager" infostring="tinyMediaManager" jvmversion="1.6+" shortname="tMM" workingdirectory="$JAVAROOT" vmoptions="-Dapple.awt.graphics.UseQuartz=true">
            <!--      <jarfileset dir=".">
              <include name="**/objectdb.conf" />
            </jarfileset> -->

            <jarfileset dir="AppBundler">
                <include name="**/getdown.jar" />
                <include name="**/getdown.txt" />
                <include name="**/splashscreen.png" />
                <include name="**/tmm.png" />
            </jarfileset>

            <jarfileset dir="build">
                <include name="**/*" />
            </jarfileset>

            <jarfileset dir="dist/getdown/">
                <include name="**/digest.txt" />
            </jarfileset>

        </jarbundler>
        <copy file="AppBundler/JavaApplicationStub" todir="dist/mac/tinyMediaManager.app/Contents/MacOS" />
        <chmod file="dist/mac/tinyMediaManager.app/Contents/MacOS/JavaApplicationStub" perm="ugo+rx" />
        <!-- <zip destfile="dist/tmm_${version}_r${svn.info.revision}_mac.zip" basedir="dist/mac"/> -->
        <zip destfile="dist/tmm_${version}_r${svn.info.revision}_mac.zip" level="9">
            <zipfileset filemode="755" dir="dist/mac" includes="tinyMediaManager.app/**/*" />
        </zip>

        <!-- Windows -->
        <property name="launch4j.dir" location="AppBundler/launch4j" />
        <taskdef name="launch4j" classname="net.sf.launch4j.ant.Launch4jTask" classpath="${launch4j.dir}/launch4j.jar
                :${launch4j.dir}/xstream.jar" />
        <mkdir dir="dist/win" />
        <mkdir dir="dist/win/lib" />
        <launch4j configFile="AppBundler/launch4j.xml" />
        <copy todir="dist/win/lib">
            <fileset dir="build/lib" includes="*" />
        </copy>
        <copy file="build/tmm.jar" todir="dist/win" />
        <copy file="build/version" todir="dist/win" />
        <copy file="objectdb.conf" todir="dist/win" />
        <copy file="AppBundler/getdown.jar" todir="dist/win" />
        <copy file="AppBundler/getdown.txt" todir="dist/win" />
        <copy file="dist/getdown/digest.txt" todir="dist/win" />
        <copy file="AppBundler/LICENSE" todir="dist/win" />
        <copy file="AppBundler/splashscreen.png" todir="dist/win" />
        <copy file="AppBundler/tmm.png" todir="dist/win" />
        <zip destfile="dist/tmm_${version}_r${svn.info.revision}_win.zip" basedir="dist/win" />

        <!-- Linux -->
        <mkdir dir="dist/linux" />
        <mkdir dir="dist/linux/lib" />
        <copy todir="dist/linux/lib">
            <fileset dir="build/lib" includes="*" />
        </copy>
        <copy file="build/tmm.jar" todir="dist/linux" />
        <copy file="build/version" todir="dist/linux" />
        <copy file="objectdb.conf" todir="dist/linux" />
        <copy file="AppBundler/getdown.jar" todir="dist/linux" />
        <copy file="AppBundler/getdown.txt" todir="dist/linux" />
        <copy file="dist/getdown/digest.txt" todir="dist/linux" />
        <copy file="AppBundler/LICENSE" todir="dist/linux" />
        <copy file="AppBundler/tinyMediaManager.sh" todir="dist/linux" />
        <chmod file="dist/linux/tinyMediaManager.sh" perm="ugo+rx" />
        <copy file="AppBundler/tmm.png" todir="dist/linux" />
        <copy file="AppBundler/splashscreen.png" todir="dist/linux" />
        <tar destfile="dist/tmm_${version}_r${svn.info.revision}_linux.tar" basedir="dist/linux" />
        <gzip destfile="dist/tmm_${version}_r${svn.info.revision}_linux.tar.gz" src="dist/tmm_${version}_r${svn.info.revision}_linux.tar" />
    </target>

    <target name="analyze" description="Run analyzers" depends="compile">
        <delete dir="reports" />
        <mkdir dir="reports" />
        <ant antfile="buildsupport/analyze.xml">
            <property name="source" value="src"/>
            <property name="classpath" refid="classpath.default"/>
            <property name="build" value="bin"/>
        </ant>
    </target>
</project>